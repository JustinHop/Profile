#!/bin/bash

# mpdnotify - put up a notification when song changes.
# JP St. Pierre
# November 1, 2008

escapify () { perl -e "use HTML::Entities; print encode_entities(\"${1//\"/\\\"}\", \"<>&\")"; } ;

# Media path. Config this.
MEDIA_PATH="/var/lib/mpd/music/"

# Main loop.
while true; do
  
  status=$(mpc | head -2 | tail -1 | grep -o '\[\(.*\)\]' | awk '{print toupper(substr($0,2,1)) substr($0,3,length($0)-3)}')
  
  # Get the info.
  artist=$(mpc --format %artist% | head -1)
  album=$(mpc --format %album% | head -1)
  title=$(mpc --format %title% | head -1)
  track=$(mpc --format %track% | head -1)
  
  # Do some magic to get the album art.
  imagedir=$MEDIA_PATH$(mpc --format %file% | head -1)
  imagedir=$(dirname "$imagedir")
  
  # Get the first .jpg in the directory.
  image=$(ls "$imagedir" | grep .jpg | head -1)
  
  if [ -n "$image" ]; then
    img="$imagedir/$(basename "$image" .jpg).small.jpg"
    # Resize it to the size I want.
    [ ! -e "$img" ] && convert "$imagedir/$image" -resize 100x100 "$img"
  else
    img=""
  fi
  
  # Escapify plz.
  artist="$(escapify "$artist")"
  album="$(escapify "$album")"
  # Send our notification.
  echo notify-send -i "$img" "$status: $track. $title" "$(echo -e $artist\\n\\n$album)"
  
  # Wait till we get a song change notification.
  echo "idle" | netcat localhost 6600 | wait
done


